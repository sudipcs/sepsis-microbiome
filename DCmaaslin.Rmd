---
title: "disc_selection"

---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

#Load libraries and data:

Required libraries:
```{r}
library(vegan)
library (ggplot2)
library(ggpubr)
library(data.table)
library(cowplot)
library(Maaslin2)
library(readr)
library(phyloseq)
library(pgirmess)
library(agricolae)
library(readxl)
library(dplyr)
library(tidyr)
library(gt)
library(FSA)

```

#How to make phyloseq object:
#Reformat table:
```{r}
# ------------------------------------------------------------
# 2️⃣ Read OTU table (Discovery cohort - DC)
# ------------------------------------------------------------
discDC <- read_excel("20250512_OTU tables_percohort_sepsis prediction model.xlsx",
                     sheet = "DC") %>% as.data.frame()

# First column contains sample IDs → make them rownames
rownames(discDC) <- discDC[[1]]
discDC <- discDC[ , -1]

# Remove unwanted PC samples (rows)
remove_samples <- paste0("DC-PC", 1:13)
discDC <- discDC[!rownames(discDC) %in% remove_samples, ]
cat("Number of samples after removing PC samples:", nrow(discDC), "\n")

# Transpose: rows = OTUs, cols = samples
DCotumat <- t(discDC)

# ------------------------------------------------------------
# 3️⃣ Read taxonomy table
# ------------------------------------------------------------
taxonomy <- read_excel("20250512_OTU tables_percohort_sepsis prediction model.xlsx",
                       sheet = "OTU table all") %>% as.data.frame()

# Use correct OTU ID column (ID.1) as rownames
rownames(taxonomy) <- taxonomy$ID.1
taxonomy <- taxonomy[ , !(colnames(taxonomy) %in% "ID.1") ]

# Keep only OTUs present in both OTU and taxonomy tables
common_otus <- intersect(rownames(DCotumat), rownames(taxonomy))
cat("Number of OTUs in both OTU and taxonomy tables:", length(common_otus), "\n")

# Subset OTU and taxonomy tables
DCotumat_common <- DCotumat[common_otus, , drop=FALSE]
taxonomy_common <- taxonomy[common_otus, , drop=FALSE]

# Sanity check
dim(DCotumat_common)
dim(taxonomy_common)

# ------------------------------------------------------------
# 4️⃣ Build phyloseq object
# ------------------------------------------------------------
OTU <- otu_table(as.matrix(DCotumat_common), taxa_are_rows = TRUE)
TAX <- tax_table(as.matrix(taxonomy_common))
physeqDC <- phyloseq(OTU, TAX)
cat("physeqDC - Samples:", nsamples(physeqDC), "OTUs:", ntaxa(physeqDC), "\n")

## new added
# 5️⃣ Add metadata
# ------------------------------------------------------------
meta_data <- read_excel("20250611_Overview samples for Animesh.xlsx", 
                        sheet = "Metadata") %>% as.data.frame()

# Filter for validation cohort 1
meta_data <- meta_data[meta_data$Cohort == "Discovery cohort", ]

# Rename columns
colnames(meta_data)[7] <- "Timeperiods"
colnames(meta_data)[9] <- "DiseaseStatus"
colnames(meta_data)[10] <- "DiseaseCausative"

# Keep only rows that exist in SV1 OTU table
meta_data_filtered <- meta_data[meta_data$Sample_ID %in% colnames(DCotumat_common), ]

# Set rownames to match sample names in physeq
rownames(meta_data_filtered) <- meta_data_filtered$Sample_ID

# Create sample_data object
sampledata <- sample_data(meta_data_filtered)

# Merge with phyloseq
physeqDC <- merge_phyloseq(physeqDC, sampledata)

cat("physeqDC with metadata - Samples:", nsamples(physeqDC), 
    "OTUs:", ntaxa(physeqDC), "\n")


```


# Keep only samples with ≥10,000 reads

```{r}
# Filter samples with at least 10,000 reads
physeqDC_filt <- prune_samples(sample_sums(physeqDC) >= 10000, physeqDC)

cat("Samples before:", nsamples(physeqDC), 
    "after filtering:", nsamples(physeqDC_filt), "\n")

```
# Remove sparse features
#Drop OTUs that are absent in most samples (e.g., >80% zero counts).
#That means: keep features present in at least 20% of samples.

```{r}
# Proportion of samples each OTU is observed in
otu_presence <- apply(otu_table(physeqDC_filt), 1, function(x) sum(x > 0) / length(x))

# Filter OTUs present in at least 20% of samples
physeqDC_filt <- prune_taxa(otu_presence >= 0.2, physeqDC_filt) # use 0.02 for - remove OTUs with >98% zeros)

cat("OTUs after filtering:", ntaxa(physeqDC_filt), "\n")

# Normalize
physeqDC_norm <- transform_sample_counts(physeqDC_filt, function(x) x / sum(x))

```
# if want, DC ASVs remaining after >98% zero filter: 1237 
# output with Summaries


```{r}

physeqDC_filt_reads <- prune_samples(sample_sums(physeqDC) >= 10000, physeqDC)


cat("\n SUMMARY STATISTICS\n")
cat("------------------------------------------------------------\n")
cat("Total fecal samples available:", nsamples(physeqDC), "\n")
cat("Total ASVs available:", ntaxa(physeqDC), "\n")
cat("Samples remaining after <10,000 reads removed:", nsamples(physeqDC_filt_reads), "\n")
cat("ASVs remaining after >80% zero filter:", ntaxa(physeqDC_filt), "\n")

meta_final <- data.frame(sample_data(physeqDC_filt))

# Control vs Disease group counts
cat("\nNumber of samples by DiseaseStatus:\n")
print(table(meta_final$DiseaseStatus))

# Percentage
cat("\nPercentage of samples by DiseaseStatus:\n")
print(round(prop.table(table(meta_final$DiseaseStatus)) * 100, 1))

# Median number of samples per infant
if("Patient.ID" %in% colnames(meta_final)) {
  samples_per_patient <- table(meta_final$Patient.ID)
  cat("\nMedian number of samples per infant:", median(samples_per_patient), "\n")
} else {
  cat("\n Patient.ID not found in metadata — skipping per-infant summary.\n")
}

cat("------------------------------------------------------------\n")
cat(" Filtering and summary completed.\n")


```


# next runs


# Prepare inputs for Maaslin2
```{r}
# Extract OTU matrix properly
otu_mat <- as(otu_table(physeqDC_norm), "matrix")

# Transpose so samples are rows
otu_maaslin <- t(otu_mat)

# Convert to data.frame with numeric entries
otu_maaslin <- as.data.frame(otu_maaslin)

# Force numeric type (while keeping OTU names as colnames)
otu_maaslin[] <- lapply(otu_maaslin, function(x) as.numeric(as.character(x)))

# Metadata
meta_maaslin <- data.frame(as(sample_data(physeqDC_norm), "data.frame"))

# Check alignment
stopifnot(all(rownames(otu_maaslin) == rownames(meta_maaslin)))



```
# metadata factors
```{r}
meta_maaslin$DiseaseStatus <- as.factor(meta_maaslin$DiseaseStatus)
meta_maaslin$Timeperiods   <- as.factor(meta_maaslin$Timeperiods)
meta_maaslin$Patient.ID    <- as.factor(meta_maaslin$Patient.ID)
```

```{r}
# Run Maaslin2: 1) LOS vs Control
fit_data <- Maaslin2(
  input_data     = otu_maaslin,
  input_metadata = meta_maaslin,
  output         = "DC_runs/outMaaslin2_LOSvsControl",
  fixed_effects  = c("DiseaseStatus", "Timeperiods"),
  random_effects = c("Patient.ID"),
  normalization  = "NONE",
  transform      = "LOG",
  analysis_method = "LM"
)
# max_significance = 0.25         # keep more for FDR control later
```


```{r}

# 1️⃣ Read Maaslin2 results
sig_res <- read_tsv("DC_runs/outMaaslin2_LOSvsControl/significant_results.tsv")

# 2️⃣ Order by q-value and pick top features (say top 20)
top_feats <- sig_res %>%
  arrange(qval) %>%
  slice(1:20) %>%
  pull(feature)   # extract feature IDs

# 3️⃣ Read your taxonomy/annotation Excel file
taxa_map <- read_excel("20250512_OTU tables_percohort_sepsis prediction model.xlsx", sheet = "OTU table all")

# Assuming your Excel has a column "ID.1" that matches feature names
# and columns: Family, Genus, Species
colnames(taxa_map) # check the actual column names!

# 4️⃣ Filter for only the top features and join taxonomy
top_taxa <- taxa_map %>%
  filter(ID.1 %in% top_feats) %>%
  select(ID.1, Family, Genus, Species)

# 5️⃣ Merge back with Maaslin results if you want effect sizes + taxonomy
final_res <- sig_res %>%
  filter(feature %in% top_feats) %>%
  left_join(taxa_map, by = c("feature" = "ID.1"))

# 6️⃣ Save the final annotated table
write.csv(final_res, "DC_runs/Top_1.features_with_taxonomy.csv", row.names = FALSE)

```


```{r}
# 3️⃣ Join results with taxonomy on feature ID
sig_taxa <- sig_res %>%
  inner_join(taxa_map, by = c("feature" = "ID.1")) %>%
  arrange(qval) %>%   # rank by qval
  select(feature, Family, Genus, Species, qval)

# 4️⃣ Save ranked table
write.csv(sig_taxa, "DC_runs/1.Significant_features_taxonomy_ranked.csv", row.names = FALSE)

```



```{r}

# Load your ranked table
sig_taxa <- read.csv("DC_runs/1.Significant_features_taxonomy_ranked.csv")

# 1️⃣ Number of unique significant features
n_unique_features <- n_distinct(sig_taxa$feature)

# 2️⃣ Number of unique features with Genus == "Escherichia-Shigella"
n_unique_escherichia <- sig_taxa %>%
  filter(Genus == "Escherichia-Shigella") %>%
  distinct(feature) %>%
  nrow()

cat("Total unique significant features:", n_unique_features, "\n")
cat("Unique features belonging to Escherichia-Shigella:", n_unique_escherichia, "\n")

```



```{r}

```


#----------------------------
# 4. S. aureus LOS vs Control
#----------------------------
```{r}
# ------------------------------------------------------------
# 1️⃣ Recoding and setting reference levels (from physeqDC)
# ------------------------------------------------------------
df_input_metadata <- data.frame(sample_data(physeqDC))

# Order time periods
df_input_metadata$Timeperiods <- factor(df_input_metadata$Timeperiods,
                                        levels = c("A", "B", "C", "D"))

# Recode DiseaseCausative
sample_data(physeqDC)$DiseaseCausative <- as.character(sample_data(physeqDC)$DiseaseCausative)
sample_data(physeqDC)$DiseaseCausative[sample_data(physeqDC)$DiseaseCausative == "0"] <- "Control"
sample_data(physeqDC)$DiseaseCausative[sample_data(physeqDC)$DiseaseCausative == "1"] <- "S_aureus_LOS"
sample_data(physeqDC)$DiseaseCausative[sample_data(physeqDC)$DiseaseCausative == "2"] <- "Gut_LOS"

sample_data(physeqDC)$DiseaseCausative <- factor(sample_data(physeqDC)$DiseaseCausative,
                                                 levels = c("Control", "Gut_LOS", "S_aureus_LOS"))

# Check counts
table(sample_data(physeqDC)$DiseaseCausative)

# ------------------------------------------------------------
# 2️⃣ Subset only Control vs S. aureus
# ------------------------------------------------------------
phy.sc <- subset_samples(physeqDC, DiseaseCausative %in% c("Control", "S_aureus_LOS"))
df_meta_sc <- data.frame(sample_data(phy.sc))

# Check balance
table(df_meta_sc$DiseaseCausative, df_meta_sc$Timeperiods)

# ------------------------------------------------------------
# 3️⃣ Run Maaslin2 for S. aureus LOS vs Control
# ------------------------------------------------------------
fit_sc <- Maaslin2(
  input_data     = t(otu_table(phy.sc)),   # transpose so rows = samples, cols = features
  input_metadata = df_meta_sc,
  output         = "DC_runs/out4Maaslin2_Saureus_vs_Control",
  fixed_effects  = c("DiseaseCausative", "Timeperiods"),
  random_effects = c("Patient.ID"),
  reference      = c("Timeperiods,A", "DiseaseCausative,Control"), # set baseline levels
  normalization  = "NONE",   # skip if already normalized
  transform      = "LOG",    # log-transform counts
  analysis_method = "LM"     # linear model
)


```


# 2. Gut-derived LOS vs Controls

```{r}
# ------------------------------------------------------------
# 2. Gut-derived LOS vs Controls
# ------------------------------------------------------------

# Subset only Control and Gut-derived LOS samples
phy.gc <- subset_samples(physeqDC, DiseaseCausative %in% c("Control", "Gut_LOS"))

# Extract metadata for MaAsLin2
df_meta_gc <- data.frame(sample_data(phy.gc))

# Optional: Check group counts by time period
table(df_meta_gc$DiseaseCausative, df_meta_gc$Timeperiods)

# Run MaAsLin2
fit_gc <- Maaslin2(
  input_data     = t(otu_table(phy.gc)),   # transpose so samples = rows
  input_metadata = df_meta_gc,
  output         = "DC_runs/out2Maaslin2_GutLOS_vs_Control",
  fixed_effects  = c("DiseaseCausative", "Timeperiods"),  # adjust for time
  random_effects = c("Patient.ID"),                       # repeated measures
  reference      = c("Timeperiods,A", "DiseaseCausative,Control"), # baseline = Control
  normalization  = "NONE",
  transform      = "LOG",
  analysis_method = "LM"
)

```



#----------------------------
# iii.  S. aureus LOS vs Gut-derived LOS (no Controls)
#----------------------------
```{r}
# ------------------------------------------------------------
# 3️⃣ S. aureus LOS vs Gut-derived LOS (no Controls)
# ------------------------------------------------------------

# Subset only Gut_LOS and S_aureus_LOS
phy.sg <- subset_samples(physeqDC, DiseaseCausative %in% c("Gut_LOS", "S_aureus_LOS"))
df_meta_sg <- data.frame(sample_data(phy.sg))

# Check balance
table(df_meta_sg$DiseaseCausative, df_meta_sg$Timeperiods)

# Run Maaslin2
fit_sg <- Maaslin2(
  input_data     = t(otu_table(phy.sg)),   # samples as rows
  input_metadata = df_meta_sg,
  output         = "DC_runs/out3Maaslin2_Saureus_vs_GutLOS",
  fixed_effects  = c("DiseaseCausative", "Timeperiods"),
  random_effects = c("Patient.ID"),
  reference      = c("Timeperiods,A", "DiseaseCausative,Gut_LOS"), # baseline = Gut_LOS
  normalization  = "NONE",
  transform      = "LOG",
  analysis_method = "LM"
)

```

# 5. E. coli LOS vs Control
# ------------------------------------------------------------
```{r}

# Use metadata from physeqDC
df_input_metadata <- data.frame(sample_data(physeqDC))
df_input_metadata$Timeperiods <- factor(df_input_metadata$Timeperiods,
                                        levels = c("A", "B", "C", "D"))

# Subset phyloseq object to only E. coli and Control samples
phy.ec <- subset_samples(physeqDC, Bloodculture_isolated_pathogen %in% c("Escherichia coli", "Control"))

# Filter metadata to only those samples present in the subset phyloseq object
df_meta_ec <- df_input_metadata[rownames(df_input_metadata) %in% sample_names(phy.ec), ]

# Ensure Bloodculture_isolated_pathogen is a factor with correct reference
df_meta_ec$Bloodculture_isolated_pathogen <- factor(
  df_meta_ec$Bloodculture_isolated_pathogen,
  levels = c("Control", "Escherichia coli")
)

# Create output directory
out_dir <- "DC_runs/out5Maaslin2_EcoliControl"
if (!dir.exists(out_dir)) dir.create(out_dir)

# Run MaAsLin2
fit_ec <- Maaslin2(
  input_data     = t(otu_table(phy.ec)),   # samples = rows
  input_metadata = df_meta_ec,
  output         = out_dir,
  fixed_effects  = c("Bloodculture_isolated_pathogen", "Timeperiods"),
  random_effects = c("Patient.ID"),
  reference      = c("Timeperiods,A", "Bloodculture_isolated_pathogen,Control"),
  normalization  = "NONE",
  transform      = "LOG",
  analysis_method = "LM"
)


```








